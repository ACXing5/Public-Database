<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1 user-scalable=no, shrink-to-fit=no">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>ACXing5's Database</title>
	<link rel="stylesheet" href="style.css">
	<link href="https://fonts.googleapis.com/css?family=Fjalla+One&display=swap" rel="stylesheet">
	<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70447982-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70447982-5');
</script>

	<!-- Common Tags -->
    <meta content='#171825' name='theme-color' />
</head>

<body>
  <div id="homeSection">
    <div class="container">
      <h1><a style="text-decoration: none; color: #000000; margin-left: 0.25rem;" href="" onclick="location.reload();">ACXing5's Database</a></h1 >
      <div id="dbList"></div>
      <button onclick="showSection('addSection')">Add Database</button>
      <button onclick="showSection('createSection')">Create Database</button>
      <button onclick="showSection('viewSection')">View Database</button>
      
    </div>
  </div>

  <div id="createSection" style="display:none">
    <div class="container">
      <h1><a style="text-decoration: none; color: #000000; margin-left: 0.25rem;" href="" onclick="location.reload();">Create Database</a></h1 >
      <input type="text" id="databaseName" placeholder="Enter database name">
      <button onclick="createDatabase()">Submit</button>
      <button onclick="showSection('homeSection')">Back</button>
    </div>
  </div>

  <div id="addSection" style="display:none">
    <div class="container">
      <h1><a style="text-decoration: none; color: #000000; margin-left: 0.25rem;" href="" onclick="location.reload();">Add Database Entry</a></h1 >
      <input type="text" id="myInput" placeholder="Enter a value">
      <button onclick="writeInput()">Submit</button>
      <button onclick="showSection('homeSection')">Back</button>
    </div>
  </div>

  <div id="viewSection" style="display:none">
    <div class="container">
      <h1><a style="text-decoration: none; color: #000000; margin-left: 0.25rem;" href="" onclick="location.reload();">View Database</a></h1 >
      <div id="entriesList"></div>
      <button onclick="showSection('homeSection')">Back</button>
    </div>
  </div>

</body>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getDatabase, ref, push, onValue, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCWZH433ys-IM8IwixQZHO9L48C9MQYrfo",
    authDomain: "public-database-72a80.firebaseapp.com",
    databaseURL: "https://public-database-72a80-default-rtdb.firebaseio.com/",
    projectId: "public-database-72a80",
    storageBucket: "public-database-72a80.appspot.com",
    messagingSenderId: "668043866524",
    appId: "1:668043866524:web:1c1e18e1e0f78d95481859",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const rootRef = ref(db, "/");

  const selectedRefName = "entries";
  const selectedRef = ref(db, selectedRefName);

  // Updates display of all database options
  const dbList = document.getElementById("dbList");

  onValue(rootRef, (snapshot) => {
    dbList.innerHTML = ""; // clear previous content
    if (snapshot.exists()) {
      snapshot.forEach((childSnapshot) => {
        const nodeName = childSnapshot.key;   // top-level node name
        const p = document.createElement("p");
        p.textContent = nodeName;
        p.style.color = "black"; 
        dbList.appendChild(p);
      });
    } else {
      const p = document.createElement("p");
      p.textContent = "No databases";
      p.style.color = "black"; 
      dbList.appendChild(p);
    }
  });
  
  async function refExists(refName) {
    get(refName).then((snapshot) => {
      if (snapshot.exists()) {
        return true;
      } else {
        return false;
      }
    }).catch((error) => { console.error(error); });
    return false;
  }

  // Updates display of viewed database
  if (refExists(selectedRef)) {
    onValue(selectedRef, (snapshot) => {
      const data = snapshot.val();
      const entriesDiv = document.getElementById("entriesList");
      entriesDiv.innerHTML = ""; // clear previous content

      for (const key in data) {
        const entry = data[key];
        if (entry.dummy) continue;
        const p = document.createElement("p");
        p.textContent = `Value: ${entry.value}, Timestamp: ${new Date(entry.timestamp).toLocaleString()}`;
        p.style.color = "black"; 
        entriesDiv.appendChild(p);
      }
    });
  }

  // Pass in attributes (e.g. value, timestamp) as parameters
  window.writeInput = function() {
    const text = document.getElementById("myInput").value;
    push(ref(db, selectedRefName), {
      value: text,
      timestamp: Date.now()
    })
    .then(() => { alert("Saved to Database!"); })
    .catch((error) => { console.error(error); });
  };

  window.createDatabase = async function() {
    const text = document.getElementById("databaseName").value;
    if(text === "") {
      alert("Please provide a database name!");
      return;
    }
    const currRef = ref(db, text);

    if (await refExists(currRef)) {
      alert("This database already exists! Please give a different name.");
    } else {
      push(currRef, {
        dummy: "dummy"
      })
        .then(() => { alert("Created new database " + text + "!"); })
        .catch((error) => { console.error(error); });
    }
  };

  // Update whenever new section added
  const sections = ["homeSection", "addSection", "viewSection", "createSection"];

  window.showSection = function(sectionName) {
    for (const section of sections) {
      document.getElementById(section).style.display = "none";
    }
    document.getElementById(sectionName).style.display = "block";
  };
</script>

</html>